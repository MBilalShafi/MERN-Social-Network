<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Facitter (FB + twitter)</title>
        <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
        <link href="/styles.css" rel="stylesheet" />
    </head>
    <body>

        <!--h1 class="title">User CRUD Application - MERN Stack</h1-->
        <div id="homepage">
            <div id="users"></div>
        </div-->

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <script src="https://unpkg.com/react@15/dist/react.js"></script>
        <script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>

        <!-- Create React Component -->
        <script type="text/babel">

        var Navbar = React.createClass({
          getInitialState: function(){

              return({
                  // define variables here

              });
          },

          render: function(){
            return(
                <div class="navbar-container">
                  <center>
                  <div className="row">
                    <div className="col-md-2">
                      <img src="img/hometext.png" />
                    </div>
                    <div className="col-md-8">
                      <input type="text" name="search" id="searcher" placeholder="enter search query" />
                    </div>
                    <div className="col-md-2">
                      <input type="button" className="mybtn btn btn-primary" value="Go" name="toggle" id="btnOK" />
                    </div>
                  </div>
                  </center>



                </div>

            );
          }
        });


        var Sidebar = React.createClass({
          getInitialState: function(){

              return({
                  // define variables here

              });
          },

          render: function(){

            const sidebarStyle  = {
              border: '3px solid #000'
            };
            return(
                <div className="sidebar-container">
                  <h2>Popular tags:</h2>
                  <div className="hashtags">
                    <div className="hashTag">
                      Maths
                    </div>
                    <div className="hashTag">
                      Algebra
                    </div>
                    <div className="hashTag">
                      Trigonometry
                    </div>
                  </div>



                </div>

            );
          }
        });

        var Users = React.createClass({
          //this.handleSubmit = this.handleSubmit.bind(this);
            getInitialState: function(){

                return({
                    step: 1,
                    errorMessage: "Click on Button to Continue",
                    username:"",
                    _id:"",
                    posts:[]
                });
            },

            render: function(){
              var posts="";
              console.log(this.state.posts);
              if(this.state.posts.length!=0){
                posts = this.state.posts;
                //this.deleteValue=this.deleteValue.bind(this);
                posts = posts.map(function(post, index){
                    return(
                      <div className="statusPost">
                        <b>Author: </b>{this.state.username}<br/><br/>
                        <b>Title:</b> {post.title}<br/>
                        <b>Content:</b> {post.content}<br/>
                      </div>

                    );
                }, this);
              } else {
                posts="No Posts Yet";
              }

              switch (this.state.step) {
                case 1: // login
                return(

                    <div id="user-container">



                      <h1>Login to System:</h1>
                      <hr />
                      <form id="add" onSubmit={this.handleLogin}>
                          <label>Username / Email:</label>
                          <input type="text" ref="loginUsername" id="name01" placeholder="your username"  />
                          <label>Password:</label>
                          <input type="password" ref="loginPwd"  />

                          <input type="submit" value="Login" />
                          <p align="center"  className="pee">
                          <a onClick={this.showRegister} className="text-center">Register</a>
                          </p>
                          <p className="pee" align="center">
                            {this.state.errorMessage}
                          </p>
                      </form>
                      <hr />

                    </div>

                  );
                case 2: // register
                    return (

                      <div id="user-container">
                      <h1>Register to System:</h1>
                      <hr />
                      <form id="register" onSubmit={this.handleRegister}>
                          <label>Username:</label>
                          <input type="text" ref="regUsername" id="name01" placeholder="your username"  />
                          <label>Password:</label>
                          <input type="password" ref="regPwd"  />
                          <label>Email:</label>
                          <input type="text" ref="regEmail" id="name01" placeholder="your email"  />
                          <label>Gender:</label>
                          <input type="text" ref="regGender" id="name01" placeholder="male/female"  />


                          <input type="submit" value="Register" />
                            <p align="center"  className="pee">
                          <a onClick={this.showLogin} className="text-center">Login</a></p>
                          <p className="pee" align="center">
                            {this.state.errorMessage}
                          </p>
                      </form>

                      <hr />
                      </div>

                    );
                    //<label>Image:</label>
                    //<input type="file" ref="file" placeholder="select an image file"  />
                case 3: // logged in
                  return (

                    <div id="user-container">
                    <h1>Welcome {this.state.username} <a onClick={this.logOut}>Logout</a></h1>
                    <hr/>
                    <h2>Add New Post:</h2>
                    <hr />
                    <form enctype="multipart/form-data" id="addpost" onSubmit={this.handlePost}>
                        <label>Title:</label>
                        <input type="text" ref="title" placeholder="title"  />
                        <label>Content:</label>

                        <textarea className="taOne" ref="content">

                        </textarea>


                        <br/>
                        <label>Tags:</label>
                        <input type="text" ref="tags" placeholder="tags (separated by comma)"  />


                        <input type="submit" value="POST NEW STATUS" />
                        <p className="pee" align="center">
                          {this.state.errorMessage}
                        </p>
                    </form>
                    <hr />
                    <h1>All posts by {this.state.username}</h1>
                    <hr />
                    {posts}
                    </div>

                  );

              }


            },

            showLogin: function(e){
                e.preventDefault();
                this.setState({
                  step: 1
                })

            },
            showRegister: function(e){

                e.preventDefault();
                this.setState({
                  step: 2
                })

            },
            logOut: function(e){

                e.preventDefault();
                this.setState({
                  step: 1,
                  errorMessage: "Successfully Logged Out",
                  _id: "",
                  username: ""
                })

            },
            getAllPosts: function(){

                // console.log(e);

                fetch('/api/posts/user/'+this.state._id)
                .then(function(data){

                    return data.json();


                }).then(json => {

                      this.setState({
                        //users: this.state.users.concat(json),
                        errorMessage: "Fetched Posts",
                        posts: json

                        //errorMessage: ""

                      });


                      //var jsArr=[];
                      //jsArr=json;
                      //console.log(jsArr.status);
                      console.log(json);
                    //handleSubmit();
                });


            },
            handleLogin: function(e){
              //var users = this.state.users;

                //console.log("The vaalue : "+ this.refs.name.value);
                e.preventDefault();
                // console.log(e);
                var _username = this.refs.loginUsername.value;
                //var _name = document.getElementById('name01').value;
                //alert(_name);
                var _pwd = this.refs.loginPwd.value;
                console.log("Picking data: "+_username+_pwd);
                fetch('/api/login', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    username: _username,
                    password:_pwd
                  })
                })
                .then(function(data){

                    return data.json();


                }).then(json => {
                  console.log(json.STATUS);
                  if(json.user){
                    console.log(json);

                      this.setState({
                        //users: this.state.users.concat(json),
                        errorMessage: "Logged In",
                        username: json.user.username,
                        _id: json.user._id,
                        step: 3
                        //errorMessage: ""

                      });
                      this.getAllPosts();
                  }
                  else {
                    this.setState({
                        errorMessage: "Sorry Please Enter Correct Credentials"

                    });
                  }

                      //var jsArr=[];
                      //jsArr=json;
                      //console.log(jsArr.status);
                      console.log(json);
                    //handleSubmit();
                });


            },
            handlePost: function(e){
              //var users = this.state.users;

                //console.log("The vaalue : "+ this.refs.name.value);
                e.preventDefault();
                // console.log(e);
                var _title = this.refs.title.value;
                //var _name = document.getElementById('name01').value;
                //alert(_name);
                var _content = this.refs.content.value;

                var _tags = this.refs.tags.value;
                //_tags.split(',');
                var _owner = this.state._id;

                //console.log("Picking data: "+_username+_pwd);
                fetch('/api/post', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    title: _title,
                    content:_content,
                    tagsText: _tags,
                    owner: _owner
                  })
                })
                .then(function(data){

                    return data.json();


                }).then(json => {
                  console.log(json.STATUS);
                  if(json.STATUS) // done
                    this.getAllPosts();
                    console.log(json);
                      this.setState({
                        //users: this.state.users.concat(json),
                        errorMessage: json.MESSAGE

                        //errorMessage: ""

                      });
                  //}
                  //else {
                    //this.setState({
                      //  errorMessage: "Sorry Please Enter Correct Credentials"

                    //});
                  //}

                      //var jsArr=[];
                      //jsArr=json;
                      //console.log(jsArr.status);
                      console.log(json);
                    //handleSubmit();
                });


            },
            handleRegister: function(e){
              //var users = this.state.users;

                //console.log("The vaalue : "+ this.refs.name.value);
                e.preventDefault();
                // console.log(e);
                var _username = this.refs.regUsername.value;
                //var _name = document.getElementById('name01').value;
                //alert(_name);
                var _pwd = this.refs.regPwd.value;
                var _email = this.refs.regEmail.value;
                var _gender = this.refs.regGender.value;

                console.log("Picking data: "+_username+_pwd);
                fetch('/api/users', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    username: _username,
                    password:_pwd,
                    email: _email,
                    gender: _gender
                  })
                })
                .then(function(data){

                    return data.json();


                }).then(json => {
                  console.log(json.STATUS);
                  //if(json.STATUS){ // done
                    console.log(json);
                      this.setState({
                        //users: this.state.users.concat(json),
                        errorMessage: json.MESSAGE

                        //errorMessage: ""

                      });
                  //}
                  //else {
                    //this.setState({
                      //  errorMessage: "Sorry Please Enter Correct Credentials"

                    //});
                  //}

                      //var jsArr=[];
                      //jsArr=json;
                      //console.log(jsArr.status);
                      console.log(json);
                    //handleSubmit();
                });


            }
/*
/*
                var users = this.state.users;
                //this.deleteValue=this.deleteValue.bind(this);
                users = users.map(function(user, index){
                    return(
                        <li key={index}>
                            <span className="true"></span>
                            <span className="name">{user.name}</span>
                            <span className="rank">{user.age} - {user.gender}</span>
                            <span className="dist">{user.score} &nbsp; &nbsp; &nbsp;
                            <input type="button" id={user._id} value="X" onClick={this.deleteValue} />
                            <input type="button" id={user._id} value="U" onClick={this.editValue} />
                            </span>
                        </li>
                    );
                }, this);
                var style="display: none";
                if (this.state.showEdit){
                  style="display: block";
                }

                var editId=this.state.editID;
                var nname=this.state.editName;

                return(

                    <div id="user-container">
                      <div className="row">
                        <div className="col-md-2">

                        </div>

                        <div className="col-md-10">

                        </div>


                      </div>
                        <form id="search" onSubmit={this.handleSubmit}>

                            <input type="submit" value="Show Users" />
                        </form>
                        <ul>{users}</ul>
                        <hr />
                        <h1>Add new User:</h1>
                        <form id="add" onSubmit={this.handleSubmitAdder}>
                            <label>Enter your Name:</label>
                            <input type="text" ref="name01" id="name01" placeholder="name"  />
                            <label>Enter your Age:</label>
                            <input type="text" ref="age01" placeholder="age"  />
                            <label>Enter your Gender:</label>
                            <input type="text" ref="gender01" placeholder="gender"  />
                            <label>Enter your Score:</label>
                            <input type="text" ref="score01" placeholder="score"  />
                            <input type="submit" value="Add User" />
                            <p className="pee" align="center">
                                {this.state.errorMessage}
                            </p>
                        </form>
                        <hr />
                        <h1>Edit Existing User:</h1>
                        <form id="edit" onSubmit={this.handleEditAdder}>
                            <label>ID:</label>
                            <input type="text" id="editID" ref="id" placeholder="id" value={editId} required />
                            <label>Enter your Name:</label>
                            <input type="text" id="editName" ref="name" placeholder="name" value={this.state.editName} onChange={e => this.onTodoNameChange(e.target.value)} required />
                            <label>Enter your Age:</label>
                            <input type="text" id="editAge" ref="age" placeholder="age" value={this.state.editAge} onChange={e => this.onTodoAgeChange(e.target.value)} required />
                            <label>Enter your Gender:</label>
                            <input type="text" id="editGender" ref="gender" placeholder="gender" value={this.state.editGender} onChange={e => this.onTodoGenderChange(e.target.value)} required />
                            <label>Enter your Score:</label>
                            <input type="text" id="editScore" ref="score" placeholder="score" value={this.state.editScore} onChange={e => this.onTodoScoreChange(e.target.value)} required />
                            <input type="submit" value="Edit User" />
                        </form>
                    </div>




                );

            },
            handleSubmit: function(e){
                e.preventDefault();

                fetch('/api/users?show=true').then(function(data){
                    return data.json();
                }).then( json => {
                    this.setState({
                        users: json
                    });
                    console.log(json);
                });
            },
            handleSubmitAdder: function(e){
              //var users = this.state.users;

                //console.log("The vaalue : "+ this.refs.name.value);
                e.preventDefault();
                // console.log(e);
                var _name = this.refs.name01.value;
                //var _name = document.getElementById('name01').value;
                //alert(_name);
                var _age = this.refs.age01.value;
                var _gender = this.refs.gender01.value;
                var _score = this.refs.score01.value;
                console.log("Picking data: "+_name+_age);
                fetch('/api/users', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    name: _name,
                    age:_age,
                    gender:_gender,
                    score:_score,
                  })
                })
                .then(function(data){

                    return data.json();


                }).then(json => {
                  console.log(json.STATUS);
                  if(json.STATUS){
                      this.setState({
                        users: this.state.users.concat(json),
                        errorMessage: json.MESSAGE
                        //errorMessage: ""

                      });
                  }
                  else {
                    this.setState({
                        errorMessage: json.MESSAGE

                    });
                  }

                      //var jsArr=[];
                      //jsArr=json;
                      //console.log(jsArr.status);
                      console.log(json);
                    //handleSubmit();
                });


            },
            handleEditAdder: function(e){
              //var users = this.state.users;

                e.preventDefault();
                console.log(e);
                var id=this.refs.id.value;
                var _name = this.refs.name.value;
                var _age = this.refs.age.value;
                var _gender = this.refs.gender.value;
                var _score = this.refs.score.value;

                fetch('/api/users/'+id, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    name: _name,
                    age:_age,
                    gender:_gender,
                    score:_score,
                  })
                })
                .then(function(data){
                    //console.log(data.json());
                    //console.log(this.state.users);
                    //this.state.users.concat(data.json());
                    return data.json();


                }).then(json => {
                  var data= this.state.users;
                  var index = -1;
                  var val = id;
                  var filteredIndex = data.find(function(item, i){
                    if(item._id === val){
                      index = i;
                      return i;
                    }
                  })

                  data.splice(index,1);
                  //data.concat(json);
                  console.log(data);
                  this.setState({
                    users: data
                  })
                  this.setState({
                    users: this.state.users.concat(json)
                  })
                });


            },
            deleteValue: function(e){
              e.preventDefault();
              var IdToDelete=e.target.id;
              //console.log(IdToDelete);

              fetch('/api/users/'+IdToDelete, {
                method: 'DELETE'

              })
              .then(function(data){
                  //console.log(data.json());
                  //console.log(this.state.users);
                  //this.state.users.concat(data.json());
                  return data.json();


              }).then(json => {


                    // update array and delete deleted element from it
                    var data= this.state.users;
                    var index = -1;
                    var val = IdToDelete;
                    var filteredIndex = data.find(function(item, i){
                      if(item._id === val){
                        index = i;
                        return i;
                      }
                    })

                    data.splice(index,1);
                    this.setState({
                      users: data,
                      errorMessage: "User has been deleted."
                    })
                  //handleSubmit();
                  console.log(json);
              });


            },
            editValue: function(e){
              var IdToEdit=e.target.id;
              var data= this.state.users;
              var index = -1;
              var val = IdToEdit;
              var eName;
              var eAge;
              var eGender;
              var eScore;
              data.find(function(item, i){
                if(item._id === val){
                  index = i;


                    eName= item.name;
                    eAge= item.age;
                    eGender= item.gender;
                    eScore= item.score;

                }
              });
              this.setState({
                editID: IdToEdit,
                editName: eName,
                editAge: eAge,
                editGender: eGender,
                editScore: eScore,
                errorMessage: "User has been edited."
              })

              //document.getElementById('edit').style={{display: 'block'}};
            },
            onTodoNameChange: function(val){
              this.setState({
                editName: val
              })
            },
            onTodoAgeChange: function(val){
              this.setState({
                editAge: val
              })
            },
            onTodoGenderChange: function(val){
              this.setState({
                editGender: val
              })
            },
            onTodoScoreChange: function(val){
              this.setState({
                editScore: val
              })
            }

            */
        });



        var App = React.createClass({
          getInitialState: function(){

              return({
                  // define variables here

              });
          },

          render: function(){
            return(
                <div class="app-container">
                  <Navbar />

                  <div className="row">
                    <div className="col-md-3">
                      <Sidebar />
                    </div>

                    <div className="col-md-9">
                      <Users />
                    </div>


                  </div>



                </div>

            );
          }
        });



        ReactDOM.render(<App />, document.getElementById('users'));
        </script>

        <!--
        <label>Enter your Latitude:</label>
        <input type="text" ref="lat" placeholder="latitude" required />
        <label>Enter your Longitude:</label>
        <input type="text" ref="lng" placeholder="longitude" required />
        -->
    </body>
</html>
